{% extends "base.html" %}
{% block title %}{{ quiz.title }}{% endblock %}

{% block content %}
<div class="row" style="align-items:flex-end; gap:14px; margin-bottom:14px;">
  <div>
    <h1 style="margin:0;">{{ quiz.title }}</h1>
    <p style="margin:6px 0 0; color: var(--muted);">Code: <b>{{ quiz.code }}</b></p>
  </div>

  <div class="actions" style="margin-left:auto; align-items:center; margin-top:0;">
    <button class="btn secondary" onclick="showQR('{{ quiz.code }}', '/quiz/{{ quiz.code }}/qr/')" title="View QR Code" style="white-space: nowrap;">üì± QR Code</button>
    <a class="btn primary" href="{% url 'create_question' quiz.id %}">+ Add Question</a>
    <a class="btn" href="{% url 'quiz_submissions' quiz.id %}">Submissions</a>

    <form method="post" action="{% url 'toggle_quiz_active' quiz.id %}" style="margin:0;">
      {% csrf_token %}
      {% if quiz.is_active %}
        <button class="btn danger" type="submit">Stop Quiz</button>
      {% else %}
        <button class="btn primary" type="submit">Re-open Quiz</button>
      {% endif %}
    </form>

    <a class="btn" href="{% url 'edit_quiz_settings' quiz.id %}">Settings</a>
  </div>
</div>

<!-- Submission Statistics Graph -->
<div class="card" style="margin-bottom: 20px;">
  <h2 style="margin-top: 0; margin-bottom: 20px;">Submission Statistics</h2>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
    <!-- Bar Chart -->
    <div style="position: relative; height: 300px;">
      <canvas id="submissionChart"></canvas>
    </div>
    
    <!-- Stats Summary -->
    <div>
      <div style="padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #4caf50;">
        <p style="margin: 0 0 5px 0; color: var(--muted); font-size: 14px;">Submitted</p>
        <p style="margin: 0; font-size: 28px; font-weight: bold; color: #4caf50;">{{ submitted_count }}</p>
        <p style="margin: 5px 0 0 0; color: var(--muted); font-size: 12px;">{{ submitted_percentage|floatformat:1 }}% of {{ total_submissions }}</p>
      </div>
      
      <div style="padding: 15px; background: rgba(244, 67, 54, 0.1); border-radius: 8px; border-left: 4px solid #f44336;">
        <p style="margin: 0 0 5px 0; color: var(--muted); font-size: 14px;">Not Submitted</p>
        <p style="margin: 0; font-size: 28px; font-weight: bold; color: #f44336;">{{ not_submitted_count }}</p>
        <p style="margin: 5px 0 0 0; color: var(--muted); font-size: 12px;">{{ not_submitted_percentage|floatformat:1 }}% of {{ total_submissions }}</p>
      </div>
    </div>
  </div>
</div>

<div class="card">
  {% if questions %}
    {% for q in questions %}
      <div class="qbox">
        <div class="row">
          <div class="qtext">
            Q{{ forloop.counter }}. {{ q.text|default:"(No text)" }}
          </div>

          <div class="actions" style="margin:0;">
            <a class="btn" href="{% url 'edit_question' quiz.id q.id %}">Edit</a>
            <a class="btn danger" href="{% url 'delete_question' quiz.id q.id %}">Delete</a>
          </div>
        </div>

        {% if q.image %}
          <img class="qimg" src="{{ q.image.url }}" alt="Question image">
        {% endif %}

        <p style="margin:10px 0 0; color:var(--muted);">
          1) {{ q.option1 }}<br>
          2) {{ q.option2 }}<br>
          3) {{ q.option3 }}<br>
          4) {{ q.option4 }}<br>
          <span class="ok">Correct:</span> Option {{ q.correct_option }}
        </p>
      </div>
    {% endfor %}
  {% else %}
    <p style="margin:0; color:var(--muted);">No questions yet. Add your first one.</p>
  {% endif %}
</div>

<div style="margin-top:14px;">
  <a class="btn" href="{% url 'teacher_quizzes' %}">‚Üê Back</a>
</div>

<!-- QR Code Modal -->
<div id="qrModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,.8); z-index: 9999; align-items: center; justify-content: center; padding: 20px;">
  <div style="background: var(--card0); border-radius: 18px; padding: 24px; text-align: center; max-width: 400px; width: 100%;">
    <h2 style="margin: 0 0 16px 0;">Quiz QR Code</h2>
    <img id="qrImage" src="" alt="QR Code" style="max-width: 100%; border-radius: 10px; margin: 16px 0; border: 2px solid var(--border);">
    <p id="qrCode" style="font-size: 14px; margin: 12px 0; word-break: break-all;"></p>
    <button class="btn primary" onclick="closeQR()" style="width: 100%;">Close</button>
  </div>
</div>

<script>
function showQR(code, qrUrl) {
  const img = document.getElementById('qrImage');
  img.src = qrUrl;
  img.alt = `QR Code for ${code}`;
  document.getElementById('qrCode').textContent = 'Quiz Code: ' + code;
  document.getElementById('qrModal').style.display = 'flex';
}

function closeQR() {
  document.getElementById('qrModal').style.display = 'none';
}

// Close modal on background click
document.getElementById('qrModal').addEventListener('click', function(e) {
  if (e.target === this) closeQR();
});
</script>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<script>
// Create submission statistics bar chart
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('submissionChart');
  if (!ctx) return;
  
  const submitted = {{ submitted_count }};
  const notSubmitted = {{ not_submitted_count }};
  const total = {{ total_submissions }};
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Submitted', 'Not Submitted'],
      datasets: [{
        label: 'Number of Students',
        data: [submitted, notSubmitted],
        backgroundColor: ['#4caf50', '#f44336'],
        borderColor: ['#45a049', '#da190b'],
        borderWidth: 1,
        borderRadius: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          max: Math.max(submitted, notSubmitted, 1),
          grid: {
            color: 'rgba(255,255,255,0.1)'
          }
        },
        y: {
          grid: {
            display: false
          }
        }
      }
    }
  });
});
</script>
{% endblock %}
